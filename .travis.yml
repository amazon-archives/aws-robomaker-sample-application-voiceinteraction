sudo: required
language: generic
notifications:
  email:
    on_success: change
    on_failure: always
    recipients:
    - ros-contributions@amazon.com
    #- travis-build@platform-notifications.robomaker.aws.a2z.com
env:
  global:
  - SA_NAME=voice-interaction
  - SA_PACKAGE_NAME=voice_interaction_robot
  - ROS_DISTRO=dashing
  - ROS_VERSION=2
  - GAZEBO_VERSION=9
  - NO_TEST=true
  - GH_USER_NAME="travis-ci"
  - GH_USER_EMAIL="travis@travis-ci.org"
  - AWS_DEFAULT_REGION=us-west-2
  - secure: avdzc7FoTdbV9TUkYtrbAbV+NI+HUuxZHrPBCHSRSH4u4kVyT7t9G/QquppYOwZCDag+RhEZJ62K3Jldz7OCoY+jS6cUpL2pZnMi0+cG/RW3ugSysmkWs/lYKIZLXVO9DObScID3R6/jsdvCSO7AnRfId7Ff1SvNqpxfzvNTmfoJfdbf6bn3kNBQMb++n5qeqSgKxgoHCS85QLcxr4hsE4ZPLvAngtGgXtALUKNHK9oNx6jpO2W/kMbCabEStvF4r5fF2JdRnNn/AEJYDRnHgrA/ZhfePwna2wdHLAKEXxY2jKENG/SSc7iO8AZIeub/8WiqWpTBgaDFcgw4LZ4KOheYFJxTKWemZXSscWFc6hl7ABmlKDesx+o2/7fnsw23yZW04nutql0zXsFdWizP8ybINPUxhROEn19FBdCHeQZdEtMaWooTTCcnby1UsIPVx1M1dCz3DCFeVrCDnbmTG9Fs0kCtwmR8Vu8Ga+7MFPlu8efZMlLlWQZ76xEoxxVicSg4v9xnSuWAhyMlivZzjVcxBITLsGa0zMPrizZt9rSqzUK1Fh6yufojOFxmruNHcn71lU11izmpmu1o/GuUk2wW/bxzqXUA/wJEI9ipOkTOUy/6IlMuLvX6M6NpYisW1ibZYR8TDKQWmOVYpCHbcxmip1rcKeVgX1Ib4fapNfQ=
  - secure: J5RaQhXDRyvnxoeuqtYQICwlVMM5UC22wVMckko7jEDEkxy74+ojGw7YkOpYvEwL3dZkZ8SNf7lsM0+Vo3AwigqVwp8lZitIlT+sTgf1Ba6VABsSQVxfluB4uzexviCTkFYcBgkqTCKXM/uiUcd1r7VT1ZKuS7MOYvLTAsFQqCPcvjfzyCqxXG4TY4i+3rBG+gtUTOlPFpQKW0ZLqeZ/cApkKKio3RzuTf+H6OVnjCGmUNmBwNE321Av0z/Y4s1xRHoWKr5jmyVUchxX/swaTP+kvbUqiTLNcHVM47fHHNb6vz3ZxdOd6JU33vwbypciFwHJwHEuIw43U4uqKugoRhTcpYhkA0+ikdUcXzGV28YwBcDQ4Y6qnTojLoLFUcLJ4d2lXhJp2fxODbijkIgrxCgKVtRv7W27mpOKxjvf5ZWvwcdj2aItA0D0vWDmUYydRuJeCrjAobHkOq7k8FI+nquPRopvuNlOLGFG7E0HdeuFVmIZCKiSeB1NxkdT+RWuuo/aqaHdP2O/NrWdq5VMDug3P3Tq1TiWL/Usp7LzW/wha8DCAb7bdBTBwPYojZ7nrwjynSaYTurI+NJZY/bM76Jljh29MNU86pAK1PDGPwJOTfhyW2mXFs/uJmmHraD7F/M8hzU5rvFtTQX0Vcbxf9jIVw4WekGcVivDhAQyHc4=
before_install:
- pip install --user awscli
install:
- git clone https://github.com/aws-robotics/travis-scripts.git .ros_ci
script:
- ". .ros_ci/add_tag.sh && set +e"
- while sleep 9m; do echo "=====[ $SECONDS seconds still running ]====="; done &
- ".ros_ci/ce_build.sh"
- kill %1
before_deploy:
- ". .ros_ci/before_deploy.sh && set +e"
deploy:
- provider: s3
  access_key_id: "$AWS_ACCESS_KEY_ID"
  secret_access_key: "$AWS_SECRET_ACCESS_KEY"
  bucket: "$S3_BUCKET_NAME"
  region: us-west-2
  local_dir: shared
  skip_cleanup: true
  wait-until-deployed: true
  on:
    branch: ros2
  upload-dir: travis/${SA_NAME}/${ROS_DISTRO}/gazebo${GAZEBO_VERSION}
jobs:
  include:
  - stage: Build & Bundle
    env: WORKSPACES="robot_ws" UPLOAD_SOURCES="false"
  - stage: Build & Bundle
    env: WORKSPACES="simulation_ws" UPLOAD_SOURCES="false"
  - stage: Upload sources
    script: ". .ros_ci/add_tag.sh && .ros_ci/prepare_sources_to_upload.sh && set +e"
    env: WORKSPACES="robot_ws simulation_ws"
  - stage: Deploy
    script: ". .ros_ci/add_tag.sh && set +e"
    before_deploy: export APP_MANIFEST_REPO=AppManifest-${SA_NAME}-${ROS_DISTRO}-gazebo${GAZEBO_VERSION}
    deploy:
    - provider: script
      script: bash .ros_ci/codepipeline_deploy.sh
      on:
        branch: ros2
after_deploy:
- ".ros_ci/post_deploy.sh"
